<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiosk 1 - Guess the Era | Memory Trail</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        .user-banner {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Segoe UI', sans-serif;
        }
        .user-banner .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-banner .trail-id {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        .user-banner .points {
            background: #fbbf24;
            color: #000;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
        }
        .no-user-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            text-align: center;
            font-family: 'Segoe UI', sans-serif;
        }
        .no-user-overlay .content {
            max-width: 400px;
            padding: 40px;
        }
        .no-user-overlay h2 {
            font-size: 28px;
            margin-bottom: 15px;
        }
        .no-user-overlay p {
            font-size: 18px;
            margin-bottom: 25px;
            opacity: 0.9;
        }
        .no-user-overlay a {
            display: inline-block;
            background: #6366f1;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: bold;
            transition: background 0.3s;
        }
        .no-user-overlay a:hover {
            background: #4f46e5;
        }
    </style>
</head>
<body>
    <!-- User Banner - Shows current player -->
    <div class="user-banner" id="userBanner" style="display: none;">
        <div class="user-info">
            <span>üéÆ Playing: <strong id="playerName">Student</strong></span>
            <span class="trail-id" id="playerTrailId">MT-XXXXXX</span>
        </div>
        <div class="points" id="playerPoints">0 pts</div>
    </div>

    <!-- No User Overlay -->
    <div class="no-user-overlay" id="noUserOverlay" style="display: none;">
        <div class="content">
            <h2>‚ö†Ô∏è No Player Detected</h2>
            <p>Please scan your QR code at the kiosk first to play this game.</p>
            <a href="kiosk.html">Go to Kiosk Scanner</a>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

       // ===== MEMORY TRAIL INTEGRATION =====
const MemoryTrailIntegration = {
    getCurrentUser: function() {
        const kioskUser = sessionStorage.getItem('kioskUser');
        if (kioskUser) {
            return JSON.parse(kioskUser);
        }
        const currentUser = localStorage.getItem('currentUser');
        if (currentUser) {
            return JSON.parse(currentUser);
        }
        return null;
    },

    awardPoints: function(points, gameId) {
        const user = this.getCurrentUser();
        if (!user) return false;

        // Only allow once per activity
        if (user.completedGames && user.completedGames.includes(gameId)) {
            return { success: false, alreadyCompleted: true };
        }

        user.points = (user.points || 0) + points;
        if (!user.completedGames) user.completedGames = [];
        user.completedGames.push(gameId);

        // Upgrade card version based on number of unique activities
        const totalActivities = 4; // Set to your total number of activities
        user.cardVersion = Math.min(1 + user.completedGames.length, totalActivities);

        this.saveUser(user);

        return { success: true, newPoints: user.points, cardVersion: user.cardVersion };
    },

    saveUser: function(user) {
        localStorage.setItem('currentUser', JSON.stringify(user));
        const users = JSON.parse(localStorage.getItem('memoryTrailUsers') || '[]');
        const index = users.findIndex(u => u.trailId === user.trailId);
        if (index !== -1) {
            users[index] = user;
            localStorage.setItem('memoryTrailUsers', JSON.stringify(users));
        }
        if (sessionStorage.getItem('kioskUser')) {
            sessionStorage.setItem('kioskUser', JSON.stringify(user));
        }
    }
};

        // Simple SVG Icons
        const CameraIcon = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                <circle cx="12" cy="13" r="4"/>
            </svg>
        );

        const TrophyIcon = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6m12 5h1.5a2.5 2.5 0 0 0 0-5H18M6 9v10a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V9M6 9h12M9 21v2m6-2v2M9 23h6M12 4v1"/>
            </svg>
        );

        const RotateIcon = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M1 4v6h6M23 20v-6h-6M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
            </svg>
        );

        const CheckIcon = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        );

        const XIcon = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24" strokeWidth="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
        );

        const GuessTheEra = () => {
            const [gameState, setGameState] = useState('start');
            const [currentPhotoIndex, setCurrentPhotoIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [selectedEra, setSelectedEra] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [currentUser, setCurrentUser] = useState(null);
            const [pointsAwarded, setPointsAwarded] = useState(null);
            const [alreadyPlayed, setAlreadyPlayed] = useState(false);

            const GAME_ID = 'kiosk1-guess-the-era';
            const POINTS_PER_CORRECT = 10;
            const BONUS_PERFECT = 20;

            // Check for user on load
            useEffect(() => {
                const user = MemoryTrailIntegration.getCurrentUser();
                if (user) {
                    setCurrentUser(user);
                    document.getElementById('userBanner').style.display = 'flex';
                    document.getElementById('playerName').textContent = user.fullName.split(' ')[0];
                    document.getElementById('playerTrailId').textContent = user.trailId;
                    document.getElementById('playerPoints').textContent = user.points + ' pts';

                    // Check if already played
                    if (user.completedGames && user.completedGames.includes(GAME_ID)) {
                        setAlreadyPlayed(true);
                    }
                } else {
                    document.getElementById('noUserOverlay').style.display = 'flex';
                }
            }, []);

            const photos = [
                {
                    id: 1,
                    description: "Ngee Ann College main building with traditional architecture",
                    correctEra: "1963-1980",
                    fact: "NP started as Ngee Ann College in 1963, focusing on Chinese culture and education.",
                    imageColor: "bg-gradient-to-br from-amber-100 to-orange-200"
                },
                {
                    id: 2,
                    description: "Students in formal uniforms attending lectures in traditional classrooms",
                    correctEra: "1963-1980",
                    fact: "Early students wore formal attire and attended classes in more traditional settings.",
                    imageColor: "bg-gradient-to-br from-yellow-100 to-amber-200"
                },
                {
                    id: 3,
                    description: "Modern polytechnic campus with expanded facilities",
                    correctEra: "1980-2000",
                    fact: "In 1981, Ngee Ann College became Ngee Ann Polytechnic, marking a major transformation.",
                    imageColor: "bg-gradient-to-br from-blue-100 to-cyan-200"
                },
                {
                    id: 4,
                    description: "Computer labs with early desktop computers",
                    correctEra: "1980-2000",
                    fact: "This era saw the introduction of technology courses and computer facilities at NP.",
                    imageColor: "bg-gradient-to-br from-green-100 to-teal-200"
                },
                {
                    id: 5,
                    description: "Modern library with digital resources and collaborative spaces",
                    correctEra: "2000-2025",
                    fact: "NP underwent rapid modernization with state-of-the-art facilities and technology integration.",
                    imageColor: "bg-gradient-to-br from-purple-100 to-pink-200"
                },
                {
                    id: 6,
                    description: "Students using tablets and laptops in contemporary learning environments",
                    correctEra: "2000-2025",
                    fact: "Modern NP embraces digital learning with smart classrooms and mobile technology.",
                    imageColor: "bg-gradient-to-br from-indigo-100 to-purple-200"
                }
            ];

            const eras = [
                { id: "1963-1980", label: "Founding Years", years: "(1963-1980)", color: "bg-amber-500 hover:bg-amber-600" },
                { id: "1980-2000", label: "College to Polytechnic", years: "(1980-2000)", color: "bg-blue-500 hover:bg-blue-600" },
                { id: "2000-2025", label: "Rapid Growth", years: "(2000-2025)", color: "bg-purple-500 hover:bg-purple-600" }
            ];

            const startGame = () => {
                setGameState('playing');
                setCurrentPhotoIndex(0);
                setScore(0);
                setSelectedEra(null);
                setFeedback(null);
            };

            const selectEra = (eraId) => {
                setSelectedEra(eraId);
            };

            const submitAnswer = () => {
                if (!selectedEra) return;

                const currentPhoto = photos[currentPhotoIndex];
                const isCorrect = selectedEra === currentPhoto.correctEra;

                if (isCorrect) {
                    setScore(score + 1);
                    setFeedback('correct');
                } else {
                    setFeedback('incorrect');
                }

                setTimeout(() => {
                    if (currentPhotoIndex < photos.length - 1) {
                        setCurrentPhotoIndex(currentPhotoIndex + 1);
                        setSelectedEra(null);
                        setFeedback(null);
                    } else {
                        // Game finished - calculate and award points
                        const finalScore = isCorrect ? score + 1 : score;
                        let totalPoints = finalScore * POINTS_PER_CORRECT;
                        
                        // Bonus for perfect score
                        if (finalScore === photos.length) {
                            totalPoints += BONUS_PERFECT;
                        }

                        // Award points if not already played
                        if (!alreadyPlayed && currentUser) {
                            const result = MemoryTrailIntegration.awardPoints(totalPoints, GAME_ID);
                            if (result.success) {
                                setPointsAwarded(totalPoints);
                                // Update display
                                document.getElementById('playerPoints').textContent = result.newPoints + ' pts';
                            }
                        }

                        setGameState('results');
                    }
                }, 2500);
            };

            const renderStartScreen = () => (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 flex items-center justify-center p-4">
                    <div className="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-8 text-center">
                        {/* Kiosk Badge */}
                        <div className="inline-block bg-purple-600 text-white px-4 py-1 rounded-full text-sm font-semibold mb-4">
                            üìç KIOSK 1
                        </div>

                        <div className="mb-6">
                            <CameraIcon className="w-20 h-20 mx-auto text-purple-600 mb-4" />
                            <h1 className="text-4xl font-bold text-gray-800 mb-2">Guess the Era</h1>
                            <p className="text-xl text-gray-600">NP History Challenge</p>
                        </div>

                        {currentUser && (
                            <div className="bg-green-50 border-2 border-green-200 rounded-xl p-4 mb-6">
                                <p className="text-green-800">
                                    üëã Welcome, <strong>{currentUser.fullName.split(' ')[0]}</strong>! 
                                    {alreadyPlayed ? (
                                        <span className="block mt-1 text-orange-600">
                                            ‚ö†Ô∏è You've already played this game. Points won't be awarded again.
                                        </span>
                                    ) : (
                                        <span className="block mt-1">
                                            Earn up to <strong>{photos.length * POINTS_PER_CORRECT + BONUS_PERFECT} points</strong>!
                                        </span>
                                    )}
                                </p>
                            </div>
                        )}
                        
                        <div className="bg-purple-50 rounded-xl p-6 mb-8">
                            <h2 className="text-2xl font-semibold text-gray-800 mb-4">How to Play</h2>
                            <div className="text-left space-y-3 text-gray-700">
                                <p>üì∏ Look at historical photos from NP's past</p>
                                <p>üïê Match each photo to the correct time period</p>
                                <p>üéØ Earn <strong>{POINTS_PER_CORRECT} points</strong> for each correct answer</p>
                                <p>üèÜ Get a <strong>{BONUS_PERFECT} point bonus</strong> for a perfect score!</p>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-4 mb-8">
                            {eras.map(era => (
                                <div key={era.id} className="bg-gray-50 rounded-lg p-4">
                                    <div className="font-semibold text-gray-800 text-sm">{era.label}</div>
                                    <div className="text-gray-600 text-xs mt-1">{era.years}</div>
                                </div>
                            ))}
                        </div>

                        <button
                            onClick={startGame}
                            className="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-12 py-4 rounded-xl text-xl font-semibold hover:from-purple-700 hover:to-pink-700 transform hover:scale-105 transition-all shadow-lg"
                        >
                            Start Game
                        </button>
                    </div>
                </div>
            );

            const renderGameScreen = () => {
                const currentPhoto = photos[currentPhotoIndex];
                const progressPercentage = ((currentPhotoIndex + 1) / photos.length) * 100;

                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-4">
                        <div className="max-w-4xl mx-auto">
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex items-center gap-3">
                                        <CameraIcon className="w-6 h-6 text-purple-600" />
                                        <span className="text-lg font-semibold text-gray-800">
                                            Photo {currentPhotoIndex + 1} of {photos.length}
                                        </span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <TrophyIcon className="w-6 h-6 text-yellow-500" />
                                        <span className="text-lg font-semibold text-gray-800">
                                            Score: {score}/{photos.length}
                                        </span>
                                    </div>
                                </div>
                                <div className="w-full bg-gray-200 rounded-full h-3">
                                    <div 
                                        className="bg-gradient-to-r from-purple-600 to-pink-600 h-3 rounded-full transition-all duration-500"
                                        style={{ width: `${progressPercentage}%` }}
                                    />
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-2xl overflow-hidden mb-6">
                                <div className={`${currentPhoto.imageColor} h-80 flex items-center justify-center p-8`}>
                                    <div className="text-center">
                                        <CameraIcon className="w-20 h-20 mx-auto mb-4 text-gray-600 opacity-50" />
                                        <p className="text-xl font-medium text-gray-700 max-w-md">
                                            {currentPhoto.description}
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {!feedback ? (
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-6 text-center">
                                        Which era does this belong to?
                                    </h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                        {eras.map(era => (
                                            <button
                                                key={era.id}
                                                onClick={() => selectEra(era.id)}
                                                className={`p-6 rounded-xl border-4 transition-all ${
                                                    selectedEra === era.id
                                                        ? 'border-purple-600 bg-purple-50 scale-105'
                                                        : 'border-gray-200 bg-white hover:border-purple-300'
                                                }`}
                                            >
                                                <div className="font-bold text-lg text-gray-800">{era.label}</div>
                                                <div className="text-gray-600 mt-1">{era.years}</div>
                                            </button>
                                        ))}
                                    </div>
                                    <button
                                        onClick={submitAnswer}
                                        disabled={!selectedEra}
                                        className={`w-full py-4 rounded-xl text-xl font-semibold transition-all ${
                                            selectedEra
                                                ? 'bg-gradient-to-r from-purple-600 to-pink-600 text-white hover:from-purple-700 hover:to-pink-700 shadow-lg'
                                                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                        }`}
                                    >
                                        Submit Answer
                                    </button>
                                </div>
                            ) : (
                                <div className={`rounded-xl shadow-lg p-8 ${
                                    feedback === 'correct' ? 'bg-green-50 border-4 border-green-500' : 'bg-red-50 border-4 border-red-500'
                                }`}>
                                    <div className="text-center mb-4">
                                        {feedback === 'correct' ? (
                                            <>
                                                <CheckIcon className="w-16 h-16 mx-auto text-green-600 mb-3" />
                                                <h3 className="text-3xl font-bold text-green-800 mb-2">Correct! üéâ</h3>
                                                <p className="text-lg text-green-700">+{POINTS_PER_CORRECT} points!</p>
                                            </>
                                        ) : (
                                            <>
                                                <XIcon className="w-16 h-16 mx-auto text-red-600 mb-3" />
                                                <h3 className="text-3xl font-bold text-red-800 mb-2">Not Quite!</h3>
                                                <p className="text-lg text-red-700 mb-3">
                                                    The correct era was: <strong>{currentPhoto.correctEra}</strong>
                                                </p>
                                            </>
                                        )}
                                    </div>
                                    <div className="bg-white rounded-lg p-6 max-w-2xl mx-auto">
                                        <p className="text-lg text-gray-700 leading-relaxed">
                                            <strong>Did you know?</strong> {currentPhoto.fact}
                                        </p>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            const renderResultsScreen = () => {
                const percentage = Math.round((score / photos.length) * 100);
                const totalPoints = score * POINTS_PER_CORRECT + (score === photos.length ? BONUS_PERFECT : 0);
                
                let message = "";
                let emoji = "";

                if (percentage === 100) {
                    message = "Perfect Score! You're an NP History Expert!";
                    emoji = "üèÜ";
                } else if (percentage >= 70) {
                    message = "Great Job! You know NP's history well!";
                    emoji = "üåü";
                } else if (percentage >= 50) {
                    message = "Good Effort! Keep learning about NP!";
                    emoji = "üëç";
                } else {
                    message = "Nice Try! Explore more of NP's heritage!";
                    emoji = "üìö";
                }

                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 flex items-center justify-center p-4">
                        <div className="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-8 text-center">
                            <div className="mb-6">
                                <div className="text-7xl mb-4">{emoji}</div>
                                <h1 className="text-4xl font-bold text-gray-800 mb-2">{message}</h1>
                            </div>

                            <div className="bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl p-8 mb-6">
                                <div className="text-6xl font-bold text-purple-600 mb-2">
                                    {score} / {photos.length}
                                </div>
                                <div className="text-2xl text-gray-700">
                                    {percentage}% Correct
                                </div>
                            </div>

                            {/* Points Earned Section */}
                            {currentUser && (
                                <div className={`rounded-xl p-6 mb-6 ${
                                    alreadyPlayed 
                                        ? 'bg-orange-50 border-2 border-orange-200' 
                                        : 'bg-green-50 border-2 border-green-200'
                                }`}>
                                    {alreadyPlayed ? (
                                        <div className="text-orange-800">
                                            <p className="text-lg">‚ö†Ô∏è You've already completed this game.</p>
                                            <p className="text-sm mt-1">Points are only awarded once per game.</p>
                                        </div>
                                    ) : (
                                        <div className="text-green-800">
                                            <p className="text-3xl font-bold mb-2">+{totalPoints} Points Earned!</p>
                                            <p className="text-sm">
                                                {score} correct √ó {POINTS_PER_CORRECT} pts
                                                {score === photos.length && ` + ${BONUS_PERFECT} bonus`}
                                            </p>
                                            <p className="text-lg mt-3">
                                                Your total: <strong>{currentUser.points + totalPoints} points</strong>
                                            </p>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* Card Upgrade Notification */}
                            {pointsAwarded && currentUser && currentUser.cardVersion > 1 && (
                                <div className="bg-yellow-50 border-2 border-yellow-300 rounded-xl p-4 mb-6">
                                    <p className="text-yellow-800 text-lg font-bold">
                                        üéâ Card Upgraded to Version {currentUser.cardVersion}!
                                    </p>
                                </div>
                            )}

                            <div className="bg-blue-50 rounded-xl p-6 mb-8 text-left">
                                <h3 className="text-xl font-bold text-gray-800 mb-3">
                                    üìç Next Steps
                                </h3>
                                <ul className="space-y-2 text-gray-700">
                                    <li>‚Ä¢ Head to <strong>Kiosk 2</strong> for the next challenge!</li>
                                    <li>‚Ä¢ Complete all kiosks to maximize your points</li>
                                    <li>‚Ä¢ Upgrade your student card to Version 4!</li>
                                </ul>
                            </div>

                            <div className="flex gap-4">
                                <button
                                    onClick={() => window.location.href = 'kiosk.html'}
                                    className="flex-1 bg-gray-200 text-gray-800 px-8 py-4 rounded-xl text-lg font-semibold hover:bg-gray-300 transition-all"
                                >
                                    ‚Üê Back to Kiosk
                                </button>
                                <button
                                    onClick={() => window.location.href = 'dashboard.html'}
                                    className="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-8 py-4 rounded-xl text-lg font-semibold hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg"
                                >
                                    View Dashboard ‚Üí
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <>
                    {gameState === 'start' && renderStartScreen()}
                    {gameState === 'playing' && renderGameScreen()}
                    {gameState === 'results' && renderResultsScreen()}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GuessTheEra />);
    </script>
</body>
</html>