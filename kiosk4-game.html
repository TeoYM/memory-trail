<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiosk 4 - Time Capsule | Memory Trail</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        .user-banner {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Segoe UI', sans-serif;
        }
        .user-banner .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-banner .trail-id {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        .user-banner .points {
            background: #fbbf24;
            color: #000;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
        }
        .no-user-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            text-align: center;
            font-family: 'Segoe UI', sans-serif;
        }
        .no-user-overlay .content {
            max-width: 400px;
            padding: 40px;
        }
        .no-user-overlay h2 {
            font-size: 28px;
            margin-bottom: 15px;
        }
        .no-user-overlay p {
            font-size: 18px;
            margin-bottom: 25px;
            opacity: 0.9;
        }
        .no-user-overlay a {
            display: inline-block;
            background: #ef4444;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: bold;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .float { animation: float 3s ease-in-out infinite; }
        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            animation: confetti 3s linear forwards;
        }
    </style>
</head>
<body>
    <div class="user-banner" id="userBanner" style="display: none;">
        <div class="user-info">
            <span>üéÆ Playing: <strong id="playerName">Student</strong></span>
            <span class="trail-id" id="playerTrailId">MT-XXXXXX</span>
        </div>
        <div class="points" id="playerPoints">0 pts</div>
    </div>

    <div class="no-user-overlay" id="noUserOverlay" style="display: none;">
        <div class="content">
            <h2>‚ö†Ô∏è No Player Detected</h2>
            <p>Please scan your QR code at the kiosk first to participate.</p>
            <a href="kiosk4.html">Go to Kiosk 4 Scanner</a>
        </div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ===== MEMORY TRAIL INTEGRATION =====
        const MemoryTrailIntegration = {
            getCurrentUser: function() {
                const kioskUser = sessionStorage.getItem('kioskUser');
                if (kioskUser) return JSON.parse(kioskUser);
                const currentUser = localStorage.getItem('currentUser');
                if (currentUser) return JSON.parse(currentUser);
                return null;
            },
            awardPoints: function(points, gameId) {
                const user = this.getCurrentUser();
                if (!user) return false;
                if (user.completedGames && user.completedGames.includes(gameId)) {
                    return { success: false, alreadyCompleted: true };
                }
                user.points = (user.points || 0) + points;
                if (!user.completedGames) user.completedGames = [];
                user.completedGames.push(gameId);
                const totalActivities = 4;
                user.cardVersion = Math.min(1 + user.completedGames.length, totalActivities);
                this.saveUser(user);
                return { success: true, newPoints: user.points, cardVersion: user.cardVersion };
            },
            saveUser: function(user) {
                localStorage.setItem('currentUser', JSON.stringify(user));
                const users = JSON.parse(localStorage.getItem('memoryTrailUsers') || '[]');
                const index = users.findIndex(u => u.trailId === user.trailId);
                if (index !== -1) {
                    users[index] = user;
                    localStorage.setItem('memoryTrailUsers', JSON.stringify(users));
                }
                if (sessionStorage.getItem('kioskUser')) {
                    sessionStorage.setItem('kioskUser', JSON.stringify(user));
                }
            }
        };

        const TimeCapsule = () => {
            const [gameState, setGameState] = useState('start');
            const [message, setMessage] = useState('');
            const [currentUser, setCurrentUser] = useState(null);
            const [alreadyPlayed, setAlreadyPlayed] = useState(false);
            const [cardUpgraded, setCardUpgraded] = useState(false);
            const [confetti, setConfetti] = useState([]);

            const GAME_ID = 'kiosk4-time-capsule';
            const POINTS = 10;

            useEffect(() => {
                const user = MemoryTrailIntegration.getCurrentUser();
                if (user) {
                    setCurrentUser(user);
                    document.getElementById('userBanner').style.display = 'flex';
                    document.getElementById('playerName').textContent = user.fullName.split(' ')[0];
                    document.getElementById('playerTrailId').textContent = user.trailId;
                    document.getElementById('playerPoints').textContent = user.points + ' pts';
                    if (user.completedGames && user.completedGames.includes(GAME_ID)) {
                        setAlreadyPlayed(true);
                    }
                } else {
                    document.getElementById('noUserOverlay').style.display = 'flex';
                }
            }, []);

            const triggerConfetti = () => {
                const colors = ['#ef4444', '#f59e0b', '#10b981', '#3b82f6', '#8b5cf6', '#ec4899'];
                const newConfetti = [];
                for (let i = 0; i < 100; i++) {
                    newConfetti.push({
                        id: i,
                        left: Math.random() * 100,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        delay: Math.random() * 2,
                        size: Math.random() * 10 + 5,
                    });
                }
                setConfetti(newConfetti);
                setTimeout(() => setConfetti([]), 4000);
            };

            const submitMessage = () => {
                if (message.trim().length < 10) {
                    alert('Please write at least 10 characters for your message.');
                    return;
                }

                // Save message to localStorage
                const messages = JSON.parse(localStorage.getItem('npTimeCapsule') || '[]');
                messages.push({
                    id: Date.now(),
                    author: currentUser?.fullName || 'Anonymous',
                    message: message,
                    timestamp: new Date().toISOString()
                });
                localStorage.setItem('npTimeCapsule', JSON.stringify(messages));

                // Award points
                if (!alreadyPlayed && currentUser) {
                    const result = MemoryTrailIntegration.awardPoints(POINTS, GAME_ID);
                    if (result.success) {
                        document.getElementById('playerPoints').textContent = result.newPoints + ' pts';
                        if (result.cardVersion === 4) {
                            setCardUpgraded(true);
                        }
                    }
                }

                triggerConfetti();
                setGameState('complete');
            };

            // Start Screen
            if (gameState === 'start') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-red-50 via-pink-50 to-orange-50 flex items-center justify-center p-4">
                        <div className="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-8 text-center">
                            <div className="inline-block bg-red-500 text-white px-4 py-1 rounded-full text-sm font-semibold mb-4">
                                üìç KIOSK 4 - FINAL ACTIVITY
                            </div>
                            <div className="text-6xl mb-4 float">üíå</div>
                            <h1 className="text-4xl font-bold text-gray-800 mb-2">Time Capsule</h1>
                            <p className="text-xl text-gray-600 mb-6">Leave a message for future NP students!</p>

                            {currentUser && (
                                <div className={`rounded-xl p-4 mb-6 ${alreadyPlayed ? 'bg-orange-50 border-2 border-orange-200' : 'bg-green-50 border-2 border-green-200'}`}>
                                    <p className={alreadyPlayed ? 'text-orange-800' : 'text-green-800'}>
                                        üëã Welcome, <strong>{currentUser.fullName.split(' ')[0]}</strong>!
                                        {alreadyPlayed ? (
                                            <span className="block mt-1">‚ö†Ô∏è You've already completed this. Submit for fun!</span>
                                        ) : (
                                            <span className="block mt-1">üéâ This is the final activity! Complete to reach Version 4!</span>
                                        )}
                                    </p>
                                </div>
                            )}

                            <div className="bg-red-50 rounded-xl p-6 mb-8 text-left">
                                <h2 className="text-xl font-semibold text-gray-800 mb-4">About This Activity</h2>
                                <ul className="space-y-2 text-gray-700">
                                    <li>üíå Write a message to future NP students</li>
                                    <li>‚è∞ Your message becomes part of NP's digital time capsule</li>
                                    <li>üí≠ Share your hopes, advice, or memories</li>
                                    <li>‚≠ê Complete this final activity to upgrade to Version 4!</li>
                                </ul>
                            </div>

                            <button
                                onClick={() => setGameState('writing')}
                                className="bg-gradient-to-r from-red-500 to-pink-500 text-white px-12 py-4 rounded-xl text-xl font-semibold hover:from-red-600 hover:to-pink-600 transform hover:scale-105 transition-all shadow-lg"
                            >
                                Start Writing
                            </button>
                        </div>
                    </div>
                );
            }

            // Writing Screen
            if (gameState === 'writing') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-red-50 via-pink-50 to-orange-50 flex items-center justify-center p-4">
                        <div className="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-8">
                            <div className="text-center mb-6">
                                <div className="text-5xl mb-4">üíå</div>
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">Write Your Message</h1>
                                <p className="text-gray-600">Share something meaningful with future NP students</p>
                            </div>

                            <div className="mb-6">
                                <label className="block text-lg font-semibold text-gray-700 mb-3">
                                    Your Message to the Future
                                </label>
                                <textarea
                                    value={message}
                                    onChange={(e) => setMessage(e.target.value)}
                                    placeholder="Dear future NP students, I hope that..."
                                    className="w-full h-48 p-4 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-red-400 text-lg resize-none"
                                    maxLength={500}
                                />
                                <div className="flex justify-between text-sm text-gray-500 mt-2">
                                    <span>{message.length}/500 characters</span>
                                    <span>Minimum 10 characters</span>
                                </div>
                            </div>

                            <div className="bg-yellow-50 border-2 border-yellow-200 rounded-xl p-4 mb-6">
                                <p className="text-yellow-800 text-sm">
                                    üí° <strong>Tip:</strong> Share advice, encouragement, or memories that would inspire future students!
                                </p>
                            </div>

                            <div className="flex gap-4">
                                <button
                                    onClick={() => setGameState('start')}
                                    className="flex-1 bg-gray-200 text-gray-800 py-4 rounded-xl text-lg font-semibold hover:bg-gray-300 transition-all"
                                >
                                    ‚Üê Back
                                </button>
                                <button
                                    onClick={submitMessage}
                                    disabled={message.trim().length < 10}
                                    className={`flex-1 py-4 rounded-xl text-lg font-semibold transition-all ${
                                        message.trim().length >= 10
                                            ? 'bg-gradient-to-r from-red-500 to-pink-500 text-white hover:from-red-600 hover:to-pink-600 shadow-lg'
                                            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
                                    }`}
                                >
                                    Submit Message üíå
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Complete Screen
            return (
                <div className="min-h-screen bg-gradient-to-br from-red-50 via-pink-50 to-orange-50 flex items-center justify-center p-4 relative overflow-hidden">
                    {/* Confetti */}
                    {confetti.map(c => (
                        <div
                            key={c.id}
                            className="confetti"
                            style={{
                                left: `${c.left}%`,
                                backgroundColor: c.color,
                                width: c.size,
                                height: c.size,
                                animationDelay: `${c.delay}s`,
                                borderRadius: Math.random() > 0.5 ? '50%' : '0',
                            }}
                        />
                    ))}

                    <div className="max-w-2xl w-full bg-white rounded-2xl shadow-2xl p-8 text-center relative z-10">
                        <div className="text-7xl mb-4">üéâ</div>
                        <h1 className="text-4xl font-bold text-gray-800 mb-2">Message Sent!</h1>
                        <p className="text-xl text-gray-600 mb-6">Your message is now part of NP's Time Capsule!</p>

                        <div className="bg-green-50 border-2 border-green-200 rounded-xl p-6 mb-6">
                            <p className="text-green-800 text-xl font-bold mb-2">‚úÖ Activity Complete!</p>
                            {!alreadyPlayed && (
                                <p className="text-green-700">You've completed the Memory Trail!</p>
                            )}
                        </div>

                        {cardUpgraded && (
                            <div className="bg-gradient-to-r from-yellow-100 to-amber-100 border-2 border-yellow-400 rounded-xl p-6 mb-6">
                                <div className="text-5xl mb-3">üèÜ</div>
                                <p className="text-yellow-800 text-2xl font-bold mb-2">
                                    Congratulations!
                                </p>
                                <p className="text-yellow-700 text-lg">
                                    You've reached <strong>Card Version 4</strong> - The Ultimate NP Explorer!
                                </p>
                            </div>
                        )}

                        <div className="bg-gray-50 rounded-xl p-4 mb-6 text-left">
                            <p className="text-gray-600 text-sm mb-2">Your message:</p>
                            <p className="text-gray-800 italic">"{message}"</p>
                        </div>

                        <div className="bg-blue-50 rounded-xl p-6 mb-6 text-left">
                            <h3 className="text-xl font-bold text-gray-800 mb-3">üéä You Did It!</h3>
                            <ul className="space-y-2 text-gray-700">
                                <li>‚úÖ All 4 activities completed</li>
                                <li>üéì Check your dashboard to see your final card</li>
                                <li>üì∏ Don't forget to screenshot your achievement!</li>
                            </ul>
                        </div>

                        <div className="flex gap-4">
                            <button
                                onClick={() => window.location.href = 'kiosk4.html'}
                                className="flex-1 bg-gray-200 text-gray-800 px-8 py-4 rounded-xl text-lg font-semibold hover:bg-gray-300 transition-all"
                            >
                                ‚Üê Back to Kiosk
                            </button>
                            <button
                                onClick={() => window.location.href = 'dashboard.html'}
                                className="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 text-white px-8 py-4 rounded-xl text-lg font-semibold hover:from-green-600 hover:to-emerald-600 transition-all shadow-lg"
                            >
                                View Dashboard üéâ
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TimeCapsule />);
    </script>
</body>
</html>